# name: Build and Push Docker Images

# on: [push]

# permissions:
#   contents: read
#   packages: write

# env:
#   ARTIFACT_LOCATION: us-central1-docker.pkg.dev
#   ARTIFACT_REPO_NAME: ofer
#   PROJECT_ID: project-for-version

# jobs:
#   setup:
#     runs-on: "ubuntu-latest"
#     outputs:
#       MATRIX: ${{ steps.sub-directories.outputs.DIRS }} 

#     steps:
#       - name: 📂 Checkout repository
#         uses: actions/checkout@v4

#       - name: 📝 list sub-directories containing Dockerfile
#         id: sub-directories
#         run: |
#           DIRS=$(find . -type f -name 'Dockerfile' -exec dirname {} \; | sed 's|^\./||' | awk -F'/' '{print $NF}' | sort -u | jq --raw-input --slurp --compact-output 'split("\n")[:-1]')
#           echo "DIRS=$DIRS" >> $GITHUB_OUTPUT 
  
#   build-and-deploy:
#     runs-on: "ubuntu-latest"
#     needs: setup
#     if: ${{ needs.setup.outputs.MATRIX != '[]' }}
#     strategy:
#       matrix:
#         directory: ${{ fromJson(needs.setup.outputs.MATRIX) }} 

#     steps:
#       - name: 📂 Checkout repository
#         uses: actions/checkout@v4

#       - name: 🗝️ Login to Container Registry
#         uses: 'google-github-actions/auth@v2'
#         with:
#           credentials_json: '${{ secrets.ACCOUNT_KEY }}'

#       - name: ⛅ Set up Cloud SDK
#         uses: 'google-github-actions/setup-gcloud@v2'

#       - name: 🔧 Configure Docker to use the gcloud
#         run: gcloud auth configure-docker ${{ env.ARTIFACT_LOCATION }}

#       - name: 🛠️ Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3  

#       - name: ✅ enable artifact registry
#         run: gcloud services enable artifactregistry.googleapis.com

#       - name: 📃 Docker metadata
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.ARTIFACT_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO_NAME }}/${{ matrix.directory }}
#           flavor: |
#             latest=false
#           tags: |
#             type=raw,value=latest
#             type=semver,pattern=v{{version}}
#             type=semver,pattern=v{{major}}.{{minor}}

#       - name: 🐳 Docker Build & Push
#         uses: docker/build-push-action@v5
#         id: docker_build
#         with:
#           context: ./${{ matrix.directory }}
#           push: true
#           provenance: false
#           labels: ${{ steps.meta.outputs.labels }}
#           tags: ${{ steps.meta.outputs.tags }}
#           file: ./${{ matrix.directory }}/Dockerfile
#           build-args: |
#             GOOGLE_CREDENTIALS=${{ secrets.ACCOUNT_KEY }}